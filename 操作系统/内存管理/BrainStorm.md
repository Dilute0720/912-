
## 开机

电脑开机时做的第一件事是为主板上的各种芯片、存储器等器件供电。如何让电脑开机就能自启动呢？这需要主板通电后自动启动一个最基本的程序——操作系统。接下来我们来看一下如何启动这样一个大型可执行文件。

As you know, 内存有所谓RAM和ROM之分（Random Access Memory/Read Only Memory）。ROM是一种不允许改写的存储器，具有高速访问的特点。计算机在设计之初就设计了这样一块不允许用户写入的私有区域，正是为了保留最基本的输入输出系统不被破坏，也就是BIOS。同时，ROM中会保留一部分重要的数据，确保其断电后不丢失。开机通电后，计算机做的第一件事就是通过BIOS检测各种硬件是否可以正常运行。然后，BIOS会初始化各种物理内存、寄存器初始值等，接着找到我们精心设计的引导区（启动区）。

回忆数逻课上手搓的CPU，它会从存储器（此处应为ROM，之后切换到RAM）的某地址开始读一条一条的指令。我们每次开机时初始化CPU从某个地址开始读取，这个地址就是BIOS的入口地址(这里可以大胆猜测CPU里面的32位寄存器可以保留这一个信息)。 BIOS会进行一系列硬件检测和初始化，然后寻找引导设备（如硬盘、SSD、USB等）并从中读取引导扇区。引导扇区包含引导加载程序的初始代码。

引导扇区（通常为512字节）的机器码会启动引导加载程序，该程序负责加载操作系统的核心部分。由于操作系统内容庞大，不能一次性全部加载到内存中，启动过程会分阶段进行。引导加载程序读取操作系统内核和其他必要组件，将它们加载到内存中并启动，从而控制计算机上的各种硬件，最终展示图形化界面。这样，开机流程就算是完成了。

## 内存

上面最后提到了把操作系统加载到内存中, 简简单单的一句其实包含了很多细节上的实现. 内存相对于磁盘来说是一种稀缺的资源, 并不能毫无顾虑的随便使用, 想用哪就用哪. 至于内存控制是学习操作系统的一个重要课题, 我们这里使用现在常用且比较完善的页表来实现.

页表页表, 首先它是一个表, 表是一种数据结构, 会在一个词条下(或者说一个页面号下)保留相关联的一系列信息. 其次得认识页, 页就是把内存空间划分成工整的一小片一小片, 每一片成为一页. 倘若内存空间很少, 只有80kb, 那么我们按照一页4kb的划分方案就只有20页, 这样的情况下页表只需要保留极少的内容: `页面号-内存地址(物理页框号)-控制位(如是否允许读写等)`就足够了.表内每一行的信息都一一对应着物理内存中的4kb空间.

但是正由于内存的空间是稀缺资源, 我们常常会需要借用磁盘的空间,这时候虚拟页表就可以实现这一需求

### 虚拟内存与页表

虚拟页表不仅包含内存中的页面映射，还要管理虚拟地址到磁盘页面的映射。这是通过将虚拟地址空间划分成更大的范围来实现的，其中一部分页面可能驻留在磁盘上而非内存中。

### 换页机制

1. **页错误（Page Fault）：**
    
    - 当CPU访问的虚拟页面不在物理内存中时，会触发页错误。这时，操作系统会介入处理。
    - 操作系统查找所需页面在磁盘上的位置，将其读入内存，同时可能需要将内存中的某个页面换出到磁盘上（如果内存已满）。
2. **换页算法：**
    
    - 操作系统使用换页算法决定哪个页面需要换出。常见的算法包括FIFO（先进先出）、LRU（最近最少使用）等。
    - 被换出的页面在页表中的有效位会被标记为无效，并记录该页面在磁盘上的位置。
3. **页面调入：**
    
    - 操作系统将所需页面从磁盘调入物理内存，更新页表条目以反映新的映射关系，并设置有效位。
    - 调入页面后，CPU重新执行引发页错误的指令，这次访问将成功。

### 页表的结构和管理

1. **多级页表：**
    
    - 为了节省内存，现代操作系统常使用多级页表（如二级页表、三级页表）。这种结构允许更灵活和高效的内存管理。
    - 每级页表负责管理一个更小范围的地址空间，通过逐级查找，实现虚拟地址到物理地址的映射。
2. **页表缓存（TLB）：**
    
    - 为了加速页表查找，CPU中常包含一个快速缓存，称为翻译后备缓冲区（Translation Lookaside Buffer, TLB）。
    - TLB存储最近使用的页表条目，可以大大加速虚拟地址到物理地址的转换。

### 总结

通过页表和虚拟内存技术，操作系统能够高效管理和利用有限的物理内存，同时提供一个更大、更灵活的虚拟地址空间。页表记录了虚拟地址与物理地址（或磁盘地址）之间的映射关系，并通过换页机制在需要时动态地在内存和磁盘之间调度页面。这样的设计不仅提高了内存利用率，还增强了系统的稳定性和灵活性。



## 磁盘?存储器?
在操作系统（OS）的学习和讨论过程中，使用“磁盘”来代指存储器的说法并不完全严谨，主要是因为“存储器”是一个更广泛的概念，而“磁盘”只是其中的一种具体类型。为了更准确地表达，我们可以区分不同类型的存储器及其具体用途。以下是详细的解释：

### 存储器的分类
1. **主存储器（Primary Storage）**
   - **RAM（随机访问存储器）：**
     - 用于存储当前正在运行的程序和数据，速度快，但断电后数据会丢失。
     - 常见的类型包括DRAM（动态随机存储器）和SRAM（静态随机存储器）。
   
2. **辅助存储器（Secondary Storage）**
   - **硬盘驱动器（HDD）：**
     - 使用磁性介质存储数据，存取速度较慢，但容量大且数据持久。
   - **固态硬盘（SSD）：**
     - 使用闪存存储数据，比HDD快，但也更贵。
   - **光盘（CD/DVD）：**
     - 使用光学介质存储数据，适合长期存储和分发。
   - **磁带：**
     - 主要用于备份和归档，存储容量大，但存取速度慢。

3. **缓存存储器（Cache Storage）**
   - **CPU缓存：**
     - 用于临时存储经常访问的数据，速度极快，但容量小。
   - **磁盘缓存：**
     - 用于加速磁盘存取的数据缓存，通常由操作系统或硬件管理。

### 使用“磁盘”代指存储器的语境
在操作系统的上下文中，使用“磁盘”来代指存储器有时是一种简化的说法，通常特指辅助存储器中的硬盘驱动器或固态硬盘。以下是一些常见情况及其严谨性分析：

1. **虚拟内存与分页（Paging）：**
   - 操作系统使用磁盘空间（通常是硬盘或SSD）来扩展物理内存，这部分磁盘空间称为“交换空间”或“页面文件”。
   - 在这种情况下，说“磁盘”是合理的，因为具体指的是用于虚拟内存的磁盘空间。

2. **文件系统管理：**
   - 文件系统主要存储在磁盘上，因此讨论文件系统时提到“磁盘”是合适的。
   - 这里的磁盘通常特指硬盘驱动器或固态硬盘。

3. **存储器层级讨论：**
   - 在更广泛的存储层级讨论中，区分主存储器（RAM）、辅助存储器（磁盘）和缓存存储器（CPU缓存）是必要的。
   - 使用“磁盘”泛指所有存储器是不严谨的，因为会混淆不同类型存储器的特点和用途。

### 更严谨的表述
在学习和讨论操作系统时，使用更精确的术语可以避免混淆：

- **主存储器：** 具体指RAM，用于存储当前运行的程序和数据。
- **辅助存储器：** 具体指硬盘、SSD等，用于长期存储数据。
- **虚拟内存：** 当需要讨论扩展内存时，明确指出是使用磁盘空间作为交换空间。
- **缓存：** 具体指CPU缓存或磁盘缓存，用于临时存储高频访问的数据。

### 总结
在操作系统的学习过程中，使用“磁盘”来代指存储器并不完全严谨，因为存储器包括多种类型，而磁盘只是其中之一。为了更准确和严谨地表达，应该根据具体的上下文使用更精确的术语，如RAM、硬盘、SSD、虚拟内存、缓存等。这不仅有助于清晰理解各类存储器的不同特点和用途，还能避免混淆和误解。